# CMSIS Pack Generation 

The utility `packgen` assists the generation of a CMSIS Pack from CMakeLists according to the standard [format](https://www.keil.com/pack/doc/CMSIS/Pack/html/packFormat.html) by reading a manifest YAML file with metadata and running the CMake generation step to retrieve CMake targets build information, namely source files, include paths and defines. 

## Requirements

- CMake: https://cmake.org/
- Ninja: https://ninja-build.org/
- Any requirement needed for running the CMake generation step over the CMake project has to be previously configured. Currently aws-iot-device-sdk-embedded-C requires Linux. See [Configuring Demos](../../README.md#configuring-demos).

In addition for validating and compressing pack files, the `PackChk` and `7z` utilities shall be in the `PATH`:
- PackChk: https://github.com/ARM-software/CMSIS_5/tree/master/CMSIS/Utilities/
- 7z: https://www.7-zip.org/
 

## Quick Start

The example input file [cmsis.yml](../../cmsis.yml) describes several AWS IoT SDK components and their inter-dependencies.
<br />
The demonstration pack can be generated by cloning the following forked branch and executing packgen tool:
```
git clone -b packgen-cmake --recurse-submodules https://github.com/brondani/aws-iot-device-sdk-embedded-C.git
cd aws-iot-device-sdk-embedded-C
tools/cmsis/linux64/packgen cmsis.yml -o generated
```
The generated pack files will be stored in the `generated` folder.

A second example that includes MCU platform layers can be generated by cloning the following forked branch:
```
git clone -b packgen-cmake --recurse-submodules https://github.com/brondani/amazon-freertos.git
cd amazon-freertos
../aws-iot-device-sdk-embedded-C/tools/cmsis/linux64/packgen cmsis.yml -o generated
```
The generated packs can be found in `generated/AWS.IoT_C-SDK.202103.0.0-Alpha` and `generated/AWS.stm32l475_discovery.1.0.0`. The `stm32l475_discovery` pack temporary provides board specific extensions that are not yet found in existing packs.

An MDK project implementing the `CORE_MQTT_MUTUAL_AUTH` demo for validating the generated components can be found in the following directory:
```
https://github.com/brondani/amazon-freertos/tree/packgen-cmake/demos/cmsis/stm32l475_discovery
```

## Usage

```
CMSIS Pack generator assistant 0.9.0
Usage:
  packgen [OPTION...] manifest.yml

  -o, --output arg  Output folder
  -r, --regenerate  Regenerate CMake targets
  -v, --verbose     Verbose mode
  -c, --nocheck     Skip pack check
  -z, --nozip       Skip *.pack file creation
  -h, --help        Print usage
  ```

## Brief description

- The contents of a `component` are retrieved from the input manifest file and from the CMake targets associated with it. If several CMake targets are listed, the build information (source files, include paths and defines) will be merged. The build information of other components or CMake targets listed as `dependencies` will be filtered out.
- External dependencies of a component can be added to the `conditions` list. When an internal component is listed as dependency, a `require` condition is automatically inserted.
- Files that are not among the build information such as config files can still join a component by adding them to the `files` list.
- After changing CMakeLists and/or other included CMake files, use the tool option `--regenerate` to rerun the CMake generation step. When changing only the input YAML file there is no need to regenerate CMake targets.
- Multiple sets of CMake options are supported and shall be inserted in the manifest file in the top level `build` section. The set(s) of options to be considered in the generation of a given component shall be inserted in the `build` field under the `components` section, while the `operation` to be applied to them can be chosen as `intersection` or `difference`.


## CMSIS manifest file

The YAML structure is described below.

``` yml
build:
  - name: <value>
    options: <value>

packs:
  - name: <value>
    description: <value>
    vendor: <value>
    license: <value>
    url: <value>
    releases:
      - version: <value>
        date: <value>
        description: <value>

    requirements:
      packages:
        - attributes: {<key:value list>}
      compilers:
        - attributes: {<key:value list>}
      languages:
        - attributes: {<key:value list>}

    taxonomy:
      - attributes: {<key:value list>}
        description: <value>

    apis:
      - name: <value>
        attributes: {<key:value list>}
        description: <value>
        files:
          - name: <value>
            attributes: {<key:value list>}
        extensions: [<list>]

    components:
      - name: <value>
        target: [<list>]
        build: [<list>]
        operation: [<intersection|difference>]
        attributes: {<key:value list>}
        description: <value>
        dependencies: [<list>]
        conditions:
          - <require|accept|deny>: {<key:value list>}
        files:
          - name: <value>
            attributes: {<key:value list>}
            conditions:
              - <require|accept|deny>: {<key:value list>}
        extensions: [<list>]
  ```
### build
| Argument        | Description
|:----------------|:----------------------------------------
| name            | Name of a set of CMake options. Multiple sets are supported
| options         | List of CMake options
<br />

### packs
| Argument        | Description
|:----------------|:----------------------------------------
| name            | Unique name of the Software Pack
| description     | Description of the Software Pack
| vendor          | Name of the supplier or vendor of the Software Pack
| license         | Path to license document
| url             | HTTP URL or file URI location of the Software Pack
| requirements    | Lists of [requirements](#requirements)
| releases        | List of Software Pack [releases](#releases)
| components      | List of Software Pack [components](#components)
<br />

### requirements
| Argument        | Description
|:----------------|:----------------------------------------
| packages        | List of required package attributes
| compilers       | List of required compiler attributes
| languages       | List of required language attributes
<br />

### releases
| Argument        | Description
|:----------------|:----------------------------------------
| version         | Semantic version number, see [Version Type](https://arm-software.github.io/CMSIS_5/Pack/html/pdsc_package_pg.html#VersionType)
| date            | Release date in the format YYYY-MM-DD
| description     | Release notes
<br />

### taxonomy
| Argument        | Description
|:----------------|:----------------------------------------
| attributes      | Typically Cclass and Cgroup, see [taxonomy](https://arm-software.github.io/CMSIS_5/latest/Pack/html/element_taxonomy.html)
| description     | Taxonomy entry brief description
<br />

### apis
| Argument        | Description
|:----------------|:----------------------------------------
| name            | Unique name of the API
| description     | API brief description
| attributes      | List of API [attributes](#attributes)
| files           | List of API [files](#files)
| extensions      | List of whitelisted file extensions for recursive copy
<br />

### components
| Argument        | Description
|:----------------|:----------------------------------------
| name            | Unique name of the component
| target          | List of CMake targets associated with the component
| build           | List of build options sets associated with the component
| operation       | Obtain the `intersection` or the `difference` of build options sets
| description     | Component brief description
| dependencies    | List of component dependencies. Other components or CMake targets are accepted.
| attributes      | List of component [attributes](#attributes)
| conditions      | List of component [conditions](#conditions)
| files           | List of component [files](#files)
| extensions      | List of whitelisted file extensions for recursive copy
<br />

### attributes
| Argument        | Description
|:----------------|:----------------------------------------
| Cclass          | Component class
| Cgroup          | Component group
| Csubgroup       | Component subgroup
| Cvariant        | Component variant
| Cversion        | Component version
<br />

### files
| Argument          | Description
|:------------------|:----------------------------------------
| name              | File path relative to the pack root directory
| attributes        | List of [file attributes](#file-attributes)
| conditions        | List of file [conditions](#conditions)
<br />

### file attributes
| Argument        | Description
|:----------------|:----------------------------------------
| category        | Defines the purpose of the file. 
| attr            | Defines the special use and handling of a file.
| version         | File-specific version information.
<br />

### conditions
| Argument          | Description
|:------------------|:----------------------------------------
| \<rule>           | It must be `require`, `accept` or `deny`
| \<key:value list> | Typically external component [attributes](#attributes), but not limited to it.
<br />

> For further info please consult the PDSC specification, for example:
- [components](https://arm-software.github.io/CMSIS_5/Pack/html/pdsc_components_pg.html#element_components)
- [conditions](https://arm-software.github.io/CMSIS_5/Pack/html/pdsc_conditions_pg.html#element_conditions) 
- [file](https://arm-software.github.io/CMSIS_5/Pack/html/pdsc_components_pg.html#element_file)
- [requirements](https://arm-software.github.io/CMSIS_5/Pack/html/element_requirements_pg.html)
